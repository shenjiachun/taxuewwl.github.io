<!DOCTYPE html>
<html>
<head>
<title>验证码及其验证实践</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child,
ol li > :first-child,
ul li ul:first-of-type,
ol li ol:first-of-type,
ul li ol:first-of-type,
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h1>验证码及其验证实践&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="../index.html">返回主页</a></h1>
<h3>最近在做一个比较大的综合项目，其中用到一些公用的工具类，本文介绍的是其中的验证码生成器部分。</h3>
<h2>代码</h2>
<h3>前台部分</h3>
<p><em>将验证码放入一个Iframe中通过a标签进行点击刷新，模拟一个异步过程，局部刷新页面防止因为刷新整个页面而导致用户输入清空</em></p>
<pre><code>    请输入验证码：&lt;input type=&quot;text&quot; name=&quot;code&quot; maxlength=&quot;4&quot; /&gt;&amp;nbsp;
                &lt;iframe id=&quot;menuFrame&quot; name=&quot;menuFrame&quot;
                    src=&quot;checkcode.png&quot; style=&quot;overflow: visible;&quot; scrolling=&quot;no&quot;
                    frameborder=&quot;no&quot; width=&quot;130px&quot; height=&quot;40px&quot;&gt; &lt;/iframe&gt; &lt;!-- 新思路：将验证码放到iframe里 --&gt;
                &lt;a href=&quot;checkcode.png&quot; target=&quot;menuFrame&quot;&gt;看不清？换一张&lt;/a&gt; &lt;br /&gt;
</code></pre>

<h3>后台部分</h3>
<p><em>这里定义验证码生成的核心逻辑，随机选取四个字符进行输出并伴随干扰线条打印到屏幕，同时记录验证码到session中，在验证逻辑中取出与前台输入的验证码进行对比验证</em>
	public class CheckCodeServlet extends HttpServlet {</p>
<pre><code>    private static final long serialVersionUID = 8496591097127600779L;

    public void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        //设置页面不缓存
        response.setHeader(&quot;Pragma&quot;, &quot;No-cache&quot;);
        response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
        response.setDateHeader(&quot;Expires&quot;, 0);
        /**
         *  在内存中生成图片（纸），没有设置背景颜色，画填充的矩形，并且和纸的大小相同，矩形有颜色。
         *  获取笔的对象（设置颜色，设置字体，画字符串，画矩形）
         *  先准备好数据，随机生成4个字符，把字符画到纸上
         *  画干扰线
         *  把内存中的图片输出到客户端上
         */
        int width = 120;
        int height = 30;
        // 在内存中生成图片
        BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        // 先获取画笔对象
        Graphics2D g = (Graphics2D) image.getGraphics();
        // 设置灰色
        g.setColor(Color.lightGray);
        // 画填充的矩形
        g.fillRect(0, 0, width, height);
        // 设置颜色
        g.setColor(Color.blue);
        // 画边框
        g.drawRect(0, 0, width-1, height-1);
        // 准备数据，随机获取4个字符
        String words = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890&quot;;
        //中文部分
        //String words = &quot;\u7684\u4e00\u4e86\u662f\u6211\u4e0d\u5728\u4eba\u4eec\u6709\u6765\u4ed6\u8fd9\u4e0a\u7740\u4e2a\u5730\u5230\u5927\u91cc\u8bf4\u5c31\u53bb\u5b50\u5f97\u4e5f\u548c\u90a3\u8981\u4e0b\u770b\u5929\u65f6\u8fc7\u51fa\u5c0f\u4e48\u8d77\u4f60\u90fd\u628a\u597d\u8fd8\u591a\u6ca1\u4e3a\u53c8\u53ef\u5bb6\u5b66\u53ea\u4ee5\u4e3b\u4f1a\u6837\u5e74\u60f3\u751f\u540c\u8001\u4e2d\u5341\u4ece\u81ea\u9762\u524d\u5934\u9053\u5b83\u540e\u7136\u8d70\u5f88\u50cf\u89c1\u4e24\u7528\u5979\u56fd\u52a8\u8fdb\u6210\u56de\u4ec0\u8fb9\u4f5c\u5bf9;

        // 设置颜色
        g.setColor(Color.yellow);
        // 设置字体
        g.setFont(new Font(&quot;隶书&quot;, Font.BOLD, 20));

        StringBuffer sb = new StringBuffer();

        Random random = new Random();
        int x = 20;
        int y = 20;
        for(int i=0;i&lt;4;i++){
            // void rotate(double theta, double x, double y)
            // theta 弧度
            // hudu = jiaodu * Math.PI / 180;
            // 获取正负30之间的角度
            int jiaodu = random.nextInt(60)-30;
            double hudu = jiaodu * Math.PI / 180;
            g.rotate(hudu, x, y);
            // 获取下标
            int index = random.nextInt(words.length());
            // 返回指定下标位置的字符，随机获取下标
            char ch = words.charAt(index);

            // 把ch装起来，存入到session中
            sb.append(ch);

            // 写字符串
            g.drawString(&quot;&quot;+ch, x, y);

            g.rotate(-hudu, x, y);
            x += 20;
        }

        // 存入session中
        HttpSession session = request.getSession();
        session.setAttribute(&quot;code&quot;, sb.toString());

        String str = (String) session.getAttribute(&quot;code&quot;);
        System.out.println(str);
        // 设置颜色
        g.setColor(Color.GREEN);
        int x1,x2,y1,y2;
        // 画干扰线
        for(int i=0;i&lt;4;i++){
            x1 = random.nextInt(width);
            y1 = random.nextInt(height);
            x2 = random.nextInt(width);
            y2 = random.nextInt(height);
            g.drawLine(x1, y1, x2, y2);
        }
        // 输出到客户端
        ImageIO.write(image, &quot;jpg&quot;, response.getOutputStream());
    }

    ...省略doPost方法
}
</code></pre>

<h2>映射</h2>
<p><em>这里将验证码生成器映射为一个png图片，更便于浏览器加载</em></p>
<pre><code>    &lt;servlet&gt;
        &lt;description&gt;&lt;/description&gt;
        &lt;display-name&gt;CheckCodeServlet&lt;/display-name&gt;
        &lt;servlet-name&gt;CheckCodeServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.snowalker.checkcode.CheckCodeServlet&lt;/servlet-class&gt;
      &lt;/servlet&gt;
      &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;CheckCodeServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/checkcode.png&lt;/url-pattern&gt;
      &lt;/servlet-mapping&gt;
</code></pre>


</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
